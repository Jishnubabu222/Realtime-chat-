{% extends 'base.html' %}

{% block title %}Chat with {{ receiver.username }}{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header d-flex align-items-center">
        <a href="{% url 'users' %}" class="btn btn-sm btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <div>
            <h5 class="mb-0 fw-bold">{{ receiver.username }}</h5>
            <small class="{% if receiver.is_online %}text-success{% else %}text-muted{% endif %}">
                {% if receiver.is_online %}Online{% else %}Offline{% endif %}
            </small>
        </div>
    </div>

    <div class="chat-messages" id="chat-messages">
        {% for msg in messages_list %}
        <div class="message {% if msg.sender == user %}message-sent{% else %}message-received{% endif %}">
            <div class="message-content">{{ msg.message }}</div>
            <div class="message-time text-end">{{ msg.timestamp|date:"H:i" }}</div>
        </div>
        {% empty %}
        <div class="text-center text-muted my-5">
            No messages yet. Start a conversation!
        </div>
        {% endfor %}
    </div>

    <div class="chat-input-area">
        <!-- onsubmit prevents page reload, message is sent via WebSocket only -->
        <form class="chat-form" onsubmit="sendMessage(); return false;">
            {% csrf_token %}
            <input type="text" id="message-input" name="message" class="form-control" placeholder="Type a message..."
                required autocomplete="off" autofocus>
            <button type="submit" class="btn btn-primary px-4">Send</button>
        </form>
    </div>
</div>

<script>
    const chatBox = document.getElementById("chat-messages");

    // CONNECT to websocket
    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/"
    );

    // when connection opens
    socket.onopen = function () {
        console.log("WebSocket Connected");
    };

    // VERY IMPORTANT â†’ receive message from server
    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);

        // const messageElement = document.createElement("p");
        // messageElement.innerHTML = "<b>" + data.user + ":</b> " + data.message;
        const messageElement = document.createElement("div");
            messageElement.className = "message " + messageClass;

            messageElement.innerHTML = `
                <div class="message {% if msg.sender == user %}message-sent{% else %}message-received{% endif %}">
                    <div class="message-content">${msg.message}</div>
                    <div class="message-time text-end">${msg.timestamp}</div>
                </div>
    `;        

        chatBox.appendChild(messageElement);

        // auto scroll
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    // if error happens
    socket.onerror = function (error) {
        console.log("WebSocket Error:", error);
    };

    // send message to server
    function sendMessage() {
        const input = document.getElementById("message-input");

        socket.send(JSON.stringify({
            "message": input.value,
            "receiver_id": "{{ receiver.id }}"
        }));

        input.value = "";
    }

    // press Enter to send
    document.getElementById("message-input").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            sendMessage();
        }
    });
</script>

{% endblock %}