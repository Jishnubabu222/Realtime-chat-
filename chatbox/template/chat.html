{% extends 'base.html' %}

{% block title %}Chat with {{ receiver.username }}{% endblock %}

{% block content %}
<div class="chat-header">
    <img src="https://ui-avatars.com/api/?name={{ receiver.username }}&background=random" class="user-avatar" alt="">
    <div class="chat-header-info flex-grow-1">
        <div class="chat-header-name">{{ receiver.username }}</div>
        <div class="chat-header-status" id="header-status">
            {% if receiver.is_online %}
            Online
            {% elif receiver.last_seen %}
            last seen {{ receiver.last_seen|date:"H:i" }}
            {% else %}
            Offline
            {% endif %}
        </div>
    </div>
    <div class="d-flex gap-3 text-secondary">
        <i class="bi bi-search cursor-pointer"></i>
        <i class="bi bi-three-dots-vertical cursor-pointer"></i>
    </div>
</div>

<div class="messages-container" id="chat-messages">
    {% for msg in messages_list %}
    <div class="message {% if msg.sender == user %}message-sent{% else %}message-received{% endif %}"
        id="msg-{{ msg.id }}">
        {% if msg.sender == user and not msg.is_deleted %}
        <button class="delete-btn" onclick="deleteMessage({{ msg.id }})">
            <i class="bi bi-chevron-down"></i>
        </button>
        {% endif %}

        <div class="message-text">
            {% if msg.is_deleted %}
            <span class="message-deleted-text"><i class="bi bi-slash-circle me-1"></i> This message was deleted</span>
            {% else %}
            {{ msg.message }}
            {% endif %}
        </div>

        <div class="message-meta">
            <span class="msg-time">{{ msg.timestamp|date:"H:i" }}</span>
            {% if msg.sender == user %}
            <i class="bi bi-check2-all text-primary small"></i>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="chat-input-area">
    <i class="bi bi-emoji-smile fs-4 text-secondary cursor-pointer"></i>
    <i class="bi bi-paperclip fs-4 text-secondary cursor-pointer"></i>
    <form class="d-flex flex-grow-1 align-items-center" onsubmit="sendMessage(); return false;">
        <input type="text" id="message-input" class="msg-input" placeholder="Type a message" autocomplete="off"
            autofocus>
        <button type="submit" class="send-btn ms-2">
            <i class="bi bi-send-fill fs-4"></i>
        </button>
    </form>
    <i class="bi bi-mic fs-4 text-secondary cursor-pointer"></i>
</div>

<script>
    const chatBox = document.getElementById("chat-messages");
    chatBox.scrollTop = chatBox.scrollHeight;

    const receiverId = "{{ receiver.id }}";

    // Clear unread count for the active receiver
    const activeBadge = document.getElementById(`unread-${receiverId}`);
    if (activeBadge) {
        activeBadge.style.display = 'none';
        activeBadge.innerText = '0';
    }

    window.handleIncomingMessage = function (data) {
        const currentUserId = "{{ user.id }}";
        const currentReceiverId = receiverId;

        // Only show message if it belongs to this conversation
        const isRelevant = (data.sender_id == currentUserId && data.receiver_id == currentReceiverId) ||
            (data.sender_id == currentReceiverId && data.receiver_id == currentUserId);

        if (!isRelevant) return;

        const isMe = data.sender_id == currentUserId;
        const msgHtml = `
            <div class="message ${isMe ? 'message-sent' : 'message-received'}" id="msg-${data.message_id}">
                ${isMe ? `<button class="delete-btn" onclick="deleteMessage(${data.message_id})"><i class="bi bi-chevron-down"></i></button>` : ''}
                <div class="message-text">${data.message}</div>
                <div class="message-meta">
                    <span class="msg-time">${data.timestamp}</span>
                    ${isMe ? '<i class="bi bi-check2-all text-primary small"></i>' : ''}
                </div>
            </div>
        `;
        chatBox.insertAdjacentHTML('beforeend', msgHtml);
        chatBox.scrollTop = chatBox.scrollHeight;

        // If it's from the other person and we are in the chat, it's effectively "read"
        // In a real app, we'd notify the server here too.
    };

    window.handleMessageDeletion = function (data) {
        const msgElem = document.getElementById(`msg-${data.message_id}`);
        if (msgElem) {
            const textElem = msgElem.querySelector('.message-text');
            textElem.innerHTML = '<span class="message-deleted-text"><i class="bi bi-slash-circle me-1"></i> This message was deleted</span>';
            const delBtn = msgElem.querySelector('.delete-btn');
            if (delBtn) delBtn.remove();
        }
    };

    function sendMessage() {
        const input = document.getElementById("message-input");
        if (input.value.trim() === "") return;

        socket.send(JSON.stringify({
            "action": "send_message",
            "message": input.value,
            "receiver_id": receiverId
        }));

        input.value = "";
    }

    function deleteMessage(msgId) {
        if (confirm("Delete message for everyone?")) {
            socket.send(JSON.stringify({
                "action": "delete_message",
                "message_id": msgId
            }));
        }
    }
</script>
{% endblock %}